<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>three.js practice</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100%; }
        </style>
    </head>
    <body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script>
        <script src='js/threex.basiclighting.js'></script>

        <script>
            var WIDTH = window.innerWidth;
            var HEIGHT = window.innerHeight;
            var aspect = WIDTH / HEIGHT;
            var viewSize = 10;
            var mouse = new THREE.Vector2();
            var ray = new THREE.Raycaster();
            var offset = new THREE.Vector3();
            var selected = null;

            var scene = new THREE.Scene();
            scene.background = new THREE.Color(0x949998);

            //var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            //var camera = new THREE.OrthographicCamera( WIDTH/-150, WIDTH/150, HEIGHT/150, HEIGHT/-150, 0, 5);
            var camera = new THREE.OrthographicCamera( viewSize * aspect / - 2, viewSize * aspect / 2, viewSize / 2, viewSize / - 2, 1, 1000 );
            camera.position.set(10,10,10);
            camera.lookAt(scene.position);
            camera.updateMatrixWorld();

            var renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(WIDTH, HEIGHT);
            document.body.appendChild(renderer.domElement);

            var colors = [];
            colors.push(new THREE.Color(0xBF1304));
            colors.push(new THREE.Color(0xBF4904));
            colors.push(new THREE.Color(0xBF7E04));
            colors.push(new THREE.Color(0xBFA004));

            var sceneObjects = [];
            var objOrder = []; //Record of stacked order
            for(let i=0; i<4; i++) {
                let c = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 1, 1),
                    new THREE.MeshPhongMaterial( { color: colors[i] } )
                );
                c.position.set(0, i, 0);
                scene.add(c);
                sceneObjects.push(c);
                objOrder.push(c);
            }

            //Aid object movement
            var plane = new THREE.Mesh(
                new THREE.PlaneBufferGeometry(500, 500, 8, 8),
                new THREE.MeshBasicMaterial({
                    wireframe: true,
                    color: 0xffffff
                })
            );
            scene.add(plane);



            //Lighting
            var light = new THREE.PointLight();
            light.position.set(5, 5, 5);
            scene.add(light);

            var lighting = new THREEx.ThreePointsLighting()
            scene.add(lighting)

            document.addEventListener('mousedown', function(){ 
                mouse.set((event.clientX/WIDTH)*2 - 1, -(event.clientY/HEIGHT)*2 + 1);
                ray.setFromCamera(mouse, camera);
                var hits = ray.intersectObjects(sceneObjects);

                if(hits.length > 0) {
                    selected = hits[0].object;

                    //A new raycast is needed for the correct offset
                    mouse.set(0, -(event.clientY/HEIGHT)*2 + 1);
                    ray.setFromCamera(mouse, camera);
                    var hits = ray.intersectObject(plane);
                    //var temp = new THREE.Vector3();
                    //temp.copy(hits[0].point);
                    //temp.x = 0;
                    offset.copy(hits[0].point).sub(selected.position);

                    //For debugging:
                   // selected.material.color = new THREE.Color ('red');
                }
            });

            document.addEventListener('mouseup', function() {
                //selected.material.color = new THREE.Color('white');
                selected = null;
            });

            document.addEventListener('mousemove', onMouseMove, false);

            function onMouseMove(event) { 
                mouse.set(0, -(event.clientY/HEIGHT)*2 + 1);
                ray.setFromCamera(mouse, camera);
                var hits = ray.intersectObjects(sceneObjects);

                if(selected != null) {
                    var hits = ray.intersectObject(plane);
                    selected.position.copy(hits[0].point.sub(offset));

                    //Lock to y-axis
                    selected.position.x = 0;
                    selected.position.z = 0;
                } else {
                    var hits = ray.intersectObjects(sceneObjects);
                    if(hits.length > 0) {
                        //plane.position.copy(hits[0].object.position);
                        //plane.lookAt(camera.position);
                    }
                }
            }

            function animate() {
                requestAnimationFrame(animate);

                renderer.render(scene, camera);
            }

            animate();
        </script>
    </body>
</html>